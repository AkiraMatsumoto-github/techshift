name: Deploy Theme to Production

on:
  push:
    branches: [ main ]
    paths:
      - 'themes/logishift/**'  # このディレクトリが変更された時だけ実行
  workflow_dispatch:  # 手動実行も可能

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        sparse-checkout: |
          themes/logishift
        sparse-checkout-cone-mode: false
    
    - name: Deploy to server via rsync
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT }}
        script: |
          # Create target directory if it doesn't exist
          mkdir -p ~/logishift.net/public_html/wp-content/themes/logishift
    
    - name: Sync files via rsync
      run: |
        # Setup SSH key
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        
        # Add server to known_hosts
        ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        
        # Deploy via rsync
        rsync -avz --delete \
          -e "ssh -i ~/.ssh/deploy_key -p ${{ secrets.SSH_PORT }}" \
          themes/logishift/ \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/logishift.net/public_html/wp-content/themes/logishift/
        
        # Cleanup
        rm ~/.ssh/deploy_key
    
    - name: Set permissions
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT }}
        script: |
          chmod -R 755 ~/logishift.net/public_html/wp-content/themes/logishift
          echo "✅ デプロイ完了！"

