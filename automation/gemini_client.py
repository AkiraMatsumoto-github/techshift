# -*- coding: utf-8 -*-
import os
import base64
import json
from google import genai
from google.genai import types
from dotenv import load_dotenv
import time
import random

load_dotenv(override=True)

class GeminiClient:
    def __init__(self):
        self.project_id = os.getenv("GOOGLE_CLOUD_PROJECT")
        self.location = os.getenv("GOOGLE_CLOUD_LOCATION")
        self.api_key = os.getenv("GEMINI_API_KEY")
        self.client = None
        self.use_vertex = False

        # Prioritize Vertex AI initialization
        if self.project_id and self.location:
            try:
                print(f"Initializing Gemini with Vertex AI (Project: {self.project_id}, Location: {self.location})")
                self.client = genai.Client(vertexai=True, project=self.project_id, location=self.location)
                self.use_vertex = True
            except Exception as e:
                print(f"Warning: Vertex AI initialization failed: {e}, falling back to API Key.")
                self.use_vertex = False
        
        # Fallback to API Key if Vertex AI is not available
        if not self.use_vertex:
            if self.api_key:
                print("Initializing Gemini with API Key (google-genai)")
                self.client = genai.Client(api_key=self.api_key)
            else:
                raise ValueError("Missing Gemini credentials. Set GOOGLE_CLOUD_PROJECT/LOCATION or GEMINI_API_KEY in .env")

    def _retry_request(self, func, *args, **kwargs):
        """
        Retry a function call with exponential backoff if a quota error occurs.
        """
        max_retries = 5
        base_delay = 2  # seconds
        
        for attempt in range(max_retries):
            try:
                return func(*args, **kwargs)
            except Exception as e:
                error_str = str(e).lower()
                # Check for rate limit/quota errors
                if "429" in error_str or "quota" in error_str or "exhausted" in error_str:
                    if attempt == max_retries - 1:
                        print(f"Max retries ({max_retries}) exceeded for quota error.")
                        raise e
                    
                    delay = (base_delay * (2 ** attempt)) + (random.random() * 1)
                    print(f"Quota exceeded (429). Retrying in {delay:.2f}s... (Attempt {attempt + 1}/{max_retries})")
                    time.sleep(delay)
                else:
                    # Not a quota error, raise immediately
                    raise e

    def generate_content(self, prompt, model='gemini-3-pro-preview', config=None):
        """
        Generic method to generate content with retry logic.
        """
        try:
            response = self._retry_request(
                self.client.models.generate_content,
                model=model,
                contents=prompt,
                config=config
            )
            return response
        except Exception as e:
            print(f"Error generating content: {e}")
            return None

    def generate_article(self, keyword, article_type="know", context=None, extra_instructions=None):
        """
        Generate a full blog article in Markdown format based on the keyword and type.
        """
        print(f"Generating article for keyword: {keyword} (Type: {article_type})")
        
        context_section = ""
        if context:
            context_section = f"""
            ## Context Information
            The following external information is relevant to the topic. Use it to ensure accuracy and freshness.
            Summary: {context.get('summary', '')}
            Key Facts: {', '.join(context.get('key_facts', []))}
            """
            
        prompts = {
            "know": f"""
            {context_section}ã‚ãªãŸã¯ç‰©æµæ¥­ç•Œã®å°‚é–€å®¶ï¼ˆSEOã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ©ã‚¤ã‚¿ãƒ¼ï¼‰ã§ã™ã€‚
            ä»¥ä¸‹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«ã¤ã„ã¦ã€èª­è€…ã®æ¤œç´¢æ„å›³ï¼ˆã‚¤ãƒ³ã‚µã‚¤ãƒˆï¼‰ã‚’æ·±ãæº€ãŸã™è§£èª¬è¨˜äº‹ã‚’åŸ·ç­†ã—ã¦ãã ã•ã„ã€‚
            
            ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: {keyword}
            
            ## ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
            - ç‰©æµæ¥­ç•Œã®åˆå¿ƒè€…ã€œä¸­ç´šè€…
            - æ¥­å‹™åŠ¹ç‡åŒ–ã‚„ã‚³ã‚¹ãƒˆå‰Šæ¸›ã«èª²é¡Œã‚’æŒã¤ç¾å ´ãƒªãƒ¼ãƒ€ãƒ¼ã€çµŒå–¶å±¤
            
            ## æ§‹æˆæ¡ˆ
            1. **å°å…¥**:
               - ã€å…±æ„Ÿã€‘èª­è€…ãŒæŠ±ãˆã‚‹å…·ä½“çš„ãªæ‚©ã¿ï¼ˆä¾‹: ã€Œæ®‹æ¥­ãŒæ¸›ã‚‰ãªã„ã€ã€Œèª¤å‡ºè·ãŒå¤šã„ã€ï¼‰ã‚’æç¤º
               - ã€è§£æ±ºã€‘ã“ã®è¨˜äº‹ã‚’èª­ã‚€ã“ã¨ã§ã©ã†è§£æ±ºã™ã‚‹ã‹ã‚’æ˜ç¤º
            2. **åŸºç¤çŸ¥è­˜**: {keyword}ã¨ã¯ä½•ã‹ï¼Ÿï¼ˆå›³è§£ã‚’æ„è­˜ã—ãŸåˆ†ã‹ã‚Šã‚„ã™ã„èª¬æ˜ï¼‰
            3. **ãªãœä»Šé‡è¦ãªã®ã‹**: 2024å¹´å•é¡Œã‚„DXã®æ½®æµãªã©ã€æ¥­ç•ŒèƒŒæ™¯ã¨çµ¡ã‚ã¦è§£èª¬
            4. **ãƒ¡ãƒªãƒƒãƒˆãƒ»åŠ¹æœ**: å°å…¥/å®Ÿæ–½ã«ã‚ˆã‚‹å…·ä½“çš„ãªå¤‰åŒ–ï¼ˆå®šé‡ãƒ»å®šæ€§ï¼‰
            5. **å®Ÿè·µ/å°å…¥ã®ãƒã‚¤ãƒ³ãƒˆ**: å¤±æ•—ã—ãªã„ãŸã‚ã®æ³¨æ„ç‚¹ã‚„ã‚¹ãƒ†ãƒƒãƒ—
            6. **ã¾ã¨ã‚**: æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆç¤¾å†…æ¤œè¨ã€è³‡æ–™åé›†ãªã©ï¼‰
            
            ## åŸ·ç­†ãƒ«ãƒ¼ãƒ«ï¼ˆSEOãƒ»å“è³ªï¼‰
            - **å…±èµ·èªãƒ»é–¢é€£èª**: {keyword}ã«é–¢é€£ã™ã‚‹å°‚é–€ç”¨èªã‚„æ¥­ç•Œç”¨èªã‚’è‡ªç„¶ã«æ–‡ä¸­ã«ç››ã‚Šè¾¼ã‚€ã“ã¨ã€‚
            - **ä¿¡é ¼æ€§**: å¯èƒ½ã§ã‚ã‚Œã°å…¬çš„ãªãƒ‡ãƒ¼ã‚¿ï¼ˆå›½äº¤çœã€æ¥­ç•Œå›£ä½“ãªã©ï¼‰ã‚„ä¸€èˆ¬çš„ãªçµ±è¨ˆå€¤ã«è¨€åŠã—ã€ä¿¡é ¼æ€§ã‚’é«˜ã‚ã‚‹ã“ã¨ï¼ˆæ¶ç©ºã®ãƒ‡ãƒ¼ã‚¿ã¯ç¦æ­¢ï¼‰ã€‚
            - **å¯èª­æ€§**:
                - ä¸€æ–‡ã¯60æ–‡å­—ä»¥å†…ã‚’ç›®å®‰ã«çŸ­ãã™ã‚‹ã€‚
                - 3è¡Œä»¥ä¸Šã®é•·æ–‡ã¯é¿ã‘ã€é©å®œæ”¹è¡Œã‚’å…¥ã‚Œã‚‹ã€‚
                - è©³ç´°ãªèª¬æ˜ã¯ç®‡æ¡æ›¸ãã‚’æ´»ç”¨ã™ã‚‹ã€‚
            
            ## ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            - Markdownå½¢å¼ï¼ˆé©åˆ‡ãªéšå±¤æ§‹é€ ã‚’ä½¿ç”¨ï¼‰
            - 3500æ–‡å­—ç¨‹åº¦
            - **è¤‡é›‘ãªæƒ…å ±ã¯Markdownãƒ†ãƒ¼ãƒ–ãƒ«ã§æ•´ç†ã™ã‚‹ï¼ˆã‚¹ãƒãƒ›è¡¨ç¤ºå´©ã‚Œé˜²æ­¢ã®ãŸã‚ã€åˆ—æ•°ã¯æœ€å¤§3åˆ—ã€ã‚»ãƒ«å†…ã¯ç°¡æ½”ã«ï¼‰**
            - **ã€å³å®ˆã€‘ãƒ†ãƒ¼ãƒ–ãƒ«å†…ã§ã¯HTMLã‚¿ã‚°ç¦æ­¢ã€‚æ”¹è¡Œã¯å¥èª­ç‚¹ã§å¯¾å¿œã€‚**
            
            ## ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆãƒ«ãƒ¼ãƒ«
            - **ç›®çš„**: æ¤œç´¢çµæœã§ã®ã‚¯ãƒªãƒƒã‚¯ç‡ï¼ˆCTRï¼‰æœ€å¤§åŒ–ã¨ã‚¿ãƒ¼ã‚²ãƒƒãƒˆèª­è€…ã¸ã®è¨´æ±‚
            - **æ–‡å­—æ•°**: 32æ–‡å­—å‰å¾Œï¼ˆã‚¹ãƒãƒ›ã§ã®è¦–èªæ€§è€ƒæ…®ã€‚æœ€å¤§40æ–‡å­—ï¼‰
            - **å¿…é ˆè¦ç´ **:
                1. **ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰**: ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€Œ{keyword}ã€ã‚’å¯èƒ½ãªé™ã‚Šå†’é ­ï¼ˆå·¦å´ï¼‰ã«é…ç½®ã™ã‚‹ã€‚
                2. **ãƒ™ãƒãƒ•ã‚£ãƒƒãƒˆ**: èª­è€…ãŒå¾—ã‚‰ã‚Œã‚‹ãƒ¡ãƒªãƒƒãƒˆï¼ˆã€ŒåŸºç¤çŸ¥è­˜ã€ã€Œå°å…¥æ‰‹é †ã€ã€Œã‚³ã‚¹ãƒˆå‰Šæ¸›ã€ãªã©ï¼‰ã‚’æ˜ç¤ºã™ã‚‹ã€‚
                3. **ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ**: èª°ã«å‘ã‘ãŸè¨˜äº‹ã‹ï¼ˆã€Œæ‹…å½“è€…å‘ã‘ã€ã€Œåˆå¿ƒè€…å¿…è¦‹ã€ï¼‰ã‚’å«ã‚ã‚‹ã€‚
            
            ## ã‚¿ã‚¤ãƒˆãƒ«æ§‹æˆã®ãƒ’ãƒ³ãƒˆï¼ˆã‚ãã¾ã§ä¾‹ã§ã™ã€‚æŸ”è»Ÿã«ç™ºæƒ³ã—ã¦ãã ã•ã„ï¼‰
            - **ç–‘å•è§£æ±ºå‹**: {keyword}ã¨ã¯ï¼Ÿç‰©æµæ‹…å½“è€…ãŒçŸ¥ã£ã¦ãŠãã¹ãå°å…¥ãƒ¡ãƒªãƒƒãƒˆã¨é¸ã³æ–¹
            - **å®Œå…¨ã‚¬ã‚¤ãƒ‰å‹**: ã€å¾¹åº•è§£èª¬ã€‘{keyword}ã®ä»•çµ„ã¿ã‹ã‚‰å°å…¥æ‰‹é †ã¾ã§ã‚’å®Œå…¨ç¶²ç¾…
            - **ã‚¿ãƒ¼ã‚²ãƒƒãƒˆç‰¹åŒ–å‹**: ä¸­å°ä¼æ¥­ã®å€‰åº«æ‹…å½“è€…ã¸ï½œ{keyword}ã§å®Ÿç¾ã™ã‚‹æ¥­å‹™åŠ¹ç‡åŒ–
            
            ã“ã‚Œã‚‰ã®è¦ç´ ã‚’çµ„ã¿åˆã‚ã›ã€æ¤œç´¢æ„å›³ï¼ˆã‚¤ãƒ³ã‚µã‚¤ãƒˆï¼‰ã«æœ€ã‚‚åˆè‡´ã—ãŸé­…åŠ›çš„ãªã‚¿ã‚¤ãƒˆãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚ã€Œã€œã«ã¤ã„ã¦è§£èª¬ã€ã¨ã„ã†è¡¨ç¾ã¯ãªã‚‹ã¹ãé¿ã‘ã€å…·ä½“æ€§ã‚’æŒãŸã›ã¦ãã ã•ã„ã€‚
            ## æ³¨æ„ç‚¹
            - ä¿¡é ¼æ„Ÿã‚’ä¸ãˆã‚‹ãŸã‚è‡ªåˆ†ã‹ã‚‰ç‰©æµã‚¨ãƒãƒ³ã‚¸ã‚§ãƒªã‚¹ãƒˆã§ã™ã¨åä¹—ã‚‰ãªã„ã“ã¨
            - **HTMLã‚¿ã‚°ï¼ˆ<br>, <p>, <div>ãªã©ï¼‰ã¯çµ¶å¯¾ã«ä½¿ç”¨ã—ãªã„ã“ã¨** 
            """,
            
            "buy": f"""
            ã‚ãªãŸã¯ç‰©æµæ¥­ç•Œã®DXã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆã§ã™ã€‚
            ä»¥ä¸‹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«é–¢é€£ã™ã‚‹ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã®ã€Œå¤±æ•—ã—ãªã„é¸ã³æ–¹ã€ã¨æ¯”è¼ƒè¨˜äº‹ã‚’åŸ·ç­†ã—ã¦ãã ã•ã„ã€‚
            
            ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: {keyword}
            
            ## ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
            - ã‚·ã‚¹ãƒ†ãƒ å°å…¥ã‚„æ©Ÿå™¨è³¼å…¥ã‚’æ¤œè¨ä¸­ã®æ±ºè£è€…ã€æ‹…å½“è€…
            
            ## æ§‹æˆæ¡ˆ
            1. **å°å…¥**: é¸å®šã®é›£ã—ã•ã«å¯„ã‚Šæ·»ã„ã€é–“é•ã£ãŸé¸ã³æ–¹ã‚’ã—ãŸéš›ã®ãƒªã‚¹ã‚¯ã‚’æç¤º
            2. **æ¯”è¼ƒãƒ»é¸å®šã®é‡è¦ãƒã‚¤ãƒ³ãƒˆ**: 
               - ã€Œä¾¡æ ¼ã€ã ã‘ã§ãªãã€Œã‚µãƒãƒ¼ãƒˆä½“åˆ¶ã€ã€Œæ‹¡å¼µæ€§ã€ã€Œç¾å ´ã®ä½¿ã„ã‚„ã™ã•ã€ãªã©ã€ãƒ—ãƒ­è¦–ç‚¹ã®é¸å®šè»¸ã‚’3ã€œ4ã¤æç¤º
            3. **ä¸»è¦ãªã‚¿ã‚¤ãƒ—åˆ†é¡**: å¸‚å ´ã«ã‚ã‚‹è£½å“ã‚’ã‚¿ã‚¤ãƒ—åˆ¥ï¼ˆä¾‹: ã‚¯ãƒ©ã‚¦ãƒ‰å‹vsã‚ªãƒ³ãƒ—ãƒ¬å‹ã€å¤§ä¼æ¥­å‘vsä¸­å°å‘ï¼‰ã«åˆ†é¡ã—ã¦è§£èª¬
            4. **ãƒ¡ãƒªãƒƒãƒˆãƒ»ãƒ‡ãƒ¡ãƒªãƒƒãƒˆæ¯”è¼ƒ**: ãã‚Œãã‚Œã®ã‚¿ã‚¤ãƒ—ã®é•·æ‰€ã¨çŸ­æ‰€ã‚’å…¬å¹³ã«æ¯”è¼ƒ
            5. **è‡ªç¤¾ã«åˆã£ãŸé¸ã³æ–¹**: ä¼šç¤¾ã®è¦æ¨¡ã‚„èª²é¡Œåˆ¥ã®ãŠã™ã™ã‚ãƒ‘ã‚¿ãƒ¼ãƒ³
            
            ## åŸ·ç­†ãƒ«ãƒ¼ãƒ«
            - **æ¯”è¼ƒè¡¨ã®è³ª**: å˜ãªã‚‹æ©Ÿèƒ½ã®æœ‰ç„¡ã ã‘ã§ãªãã€ã€Œã©ã‚“ãªä¼æ¥­ã«å‘ã„ã¦ã„ã‚‹ã‹ã€ãŒä¸€ç›®ã§åˆ†ã‹ã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚
            - **ä¸­ç«‹æ€§**: ç‰¹å®šã®è£½å“ã‚’éåº¦ã«æŒã¡ä¸Šã’ãšã€ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã‚‚æ­£ç›´ã«ä¼ãˆã‚‹ã“ã¨ã§è¨˜äº‹ã®ä¿¡é ¼æ€§ã‚’æ‹…ä¿ã™ã‚‹ã€‚
            
            ## ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            - Markdownå½¢å¼
            - æ¯”è¼ƒè¡¨ï¼ˆMarkdownãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰å¿…é ˆ
            - **å„è£½å“ã®æ¯”è¼ƒã‚„ãƒ¡ãƒªãƒƒãƒˆãƒ»ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã¯å¿…ãšãƒ†ãƒ¼ãƒ–ãƒ«ã§æ•´ç†ã™ã‚‹**
            - **ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆæ™‚ã®æ³¨æ„: ãƒ¢ãƒã‚¤ãƒ«ã§ã®é–²è¦§ã‚’è€ƒæ…®ã—ã€èª¬æ˜æ–‡ã¯æ¥µåŠ›çŸ­ãä½“è¨€æ­¢ã‚ç­‰ã‚’ä½¿ç”¨ã™ã‚‹ã€‚**
            - **ã€é‡è¦ã€‘Markdownãƒ†ãƒ¼ãƒ–ãƒ«å†…ã§ã¯<br>ã‚¿ã‚°ã‚„ä»–ã®HTMLã‚¿ã‚°ã‚’ä¸€åˆ‡ä½¿ç”¨ç¦æ­¢ã€‚æ”¹è¡ŒãŒå¿…è¦ãªå ´åˆã¯ã€ã‚»ãƒ«å†…ã§è‡ªç„¶ãªæ–‡ç« ã¨ã—ã¦è¨˜è¿°ã™ã‚‹**
            - 3500æ–‡å­—ç¨‹åº¦
            
            ## ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆãƒ«ãƒ¼ãƒ«
            - **ç›®çš„**: æ¯”è¼ƒæ¤œè¨å±¤ï¼ˆBuyã‚¯ã‚¨ãƒªï¼‰ã®æ¤œç´¢æ„å›³ã‚’æº€ãŸã—ã€è¨˜äº‹ã¸ã®ä¿¡é ¼æ„Ÿã‚’é†¸æˆã™ã‚‹
            - **æ–‡å­—æ•°**: 32æ–‡å­—å‰å¾Œï¼ˆæœ€å¤§40æ–‡å­—ï¼‰
            - **å¿…é ˆè¦ç´ **:
                1. **ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰**: ã€Œ{keyword}ã€ã‚’å†’é ­ã«é…ç½®ã€‚
                2. **æ•°å­—**: ã€Œ10é¸ã€ã€Œ3ã¤ã®ãƒã‚¤ãƒ³ãƒˆã€ãªã©ã€å…·ä½“çš„ãªæ•°å­—ã‚’å…¥ã‚Œã‚‹ã€‚
                3. **æœ€æ–°æ€§**: ã€Œ2025å¹´æœ€æ–°ã€ã€Œæ±ºå®šç‰ˆã€ãªã©ã€æƒ…å ±ã®é®®åº¦ã‚’ã‚¢ãƒ”ãƒ¼ãƒ«ã™ã‚‹ã€‚
            
            ## ã‚¿ã‚¤ãƒˆãƒ«æ§‹æˆã®ãƒ’ãƒ³ãƒˆï¼ˆæŸ”è»Ÿã«çµ„ã¿åˆã‚ã›ã¦ãã ã•ã„ï¼‰
            - **ãƒ©ãƒ³ã‚­ãƒ³ã‚°/é¸å®šå‹**: ã€2025å¹´æœ€æ–°ã€‘{keyword}ãŠã™ã™ã‚10é¸ï¼ä¾¡æ ¼ãƒ»æ©Ÿèƒ½ã‚’å¾¹åº•æ¯”è¼ƒ
            - **å¤±æ•—å›é¿å‹**: å¤±æ•—ã—ãªã„{keyword}ã®é¸ã³æ–¹ï½œãƒ—ãƒ­ãŒæ•™ãˆã‚‹3ã¤ã®é‡è¦ãƒã‚¤ãƒ³ãƒˆ
            - **ç›®çš„ç‰¹åŒ–å‹**: å°è¦æ¨¡å€‰åº«ã«æœ€é©ãªã®ã¯ï¼Ÿ{keyword}ã®ã‚¿ã‚¤ãƒ—åˆ¥æ¯”è¼ƒã‚¬ã‚¤ãƒ‰
            
            ã€Œã€œã«ã¤ã„ã¦è§£èª¬ã€ãªã©ã®å¼±ã„è¡¨ç¾ã¯é¿ã‘ã€ã€Œã€œé¸ã€ã€Œã€œã‚¬ã‚¤ãƒ‰ã€ã€Œã€œæ¯”è¼ƒã€ãªã©ã€æƒ…å ±ã‚’æ¢ã—ã¦ã„ã‚‹èª­è€…ã«åˆºã•ã‚‹è¨€è‘‰ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚
            ## æ³¨æ„ç‚¹
            - ä¿¡é ¼æ„Ÿã‚’ä¸ãˆã‚‹ãŸã‚è‡ªåˆ†ã‹ã‚‰ç‰©æµã‚¨ãƒãƒ³ã‚¸ã‚§ãƒªã‚¹ãƒˆã§ã™ã¨åä¹—ã‚‰ãªã„ã“ã¨
            - **HTMLã‚¿ã‚°ï¼ˆ<br>, <p>, <div>ãªã©ï¼‰ã¯çµ¶å¯¾ã«ä½¿ç”¨ã—ãªã„ã“ã¨** 
            """,
            
            "do": f"""
            ã‚ãªãŸã¯ç‰©æµæ¥­ç•Œã®DXã‚¨ãƒãƒ³ã‚¸ã‚§ãƒªã‚¹ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«é–¢é€£ã™ã‚‹å…·ä½“çš„ãªäº‹ä¾‹ã‚„ãƒã‚¦ãƒã‚¦è¨˜äº‹ã‚’åŸ·ç­†ã—ã¦ãã ã•ã„ã€‚
            
            ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: {keyword}
            
            ## ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
            - ç¾å ´æ”¹å–„ã‚’ç›®æŒ‡ã™å€‰åº«ç®¡ç†è€…ã€å®Ÿå‹™æ‹…å½“è€…
            
            ## æ§‹æˆæ¡ˆ
            1. **å°å…¥**: ã‚ˆãã‚ã‚‹ç¾å ´ã®æ‚©ã¿ï¼ˆBeforeï¼‰
            2. **è§£æ±ºç­–ã®æç¤º**: {keyword}ã‚’æ´»ç”¨ã—ãŸå…·ä½“çš„ãªæ‰‹æ³•ï¼ˆWhatï¼‰
            3. **å®Ÿè·µãƒ—ãƒ­ã‚»ã‚¹**: ã©ã®ã‚ˆã†ã«å°å…¥ãƒ»å®Ÿè·µã™ã‚‹ã‹ï¼ˆHowï¼‰
            4. **æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ**: å°å…¥å¾Œã®å¤‰åŒ–ï¼ˆAfterã€å®šé‡ãƒ»å®šæ€§ï¼‰
            5. **ã¾ã¨ã‚**: æˆåŠŸã®ç§˜è¨£
            
            ## ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            - Markdownå½¢å¼
            - å…·ä½“çš„ãªæ•°å­—ã‚„ã‚¹ãƒ†ãƒƒãƒ—ã‚’å«ã‚ã‚‹
            - **æ‰‹é †ã‚„Before/Afterã®æ¯”è¼ƒã¯Markdownãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹**
            - **Markdownãƒ†ãƒ¼ãƒ–ãƒ«å†…ã§ã¯HTMLã‚¿ã‚°ï¼ˆ<br>ãªã©ï¼‰ã‚’çµ¶å¯¾ã«ä½¿ç”¨ã›ãšã€ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã‚’ä½¿ç”¨ã™ã‚‹**
            - 3500æ–‡å­—ç¨‹åº¦
            
            ## ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆãƒ«ãƒ¼ãƒ«
            - **ç›®çš„**: ç¾å ´ã®èª²é¡Œè§£æ±ºï¼ˆDoã‚¯ã‚¨ãƒªï¼‰ã‚’æ±‚ã‚ã¦ã„ã‚‹èª­è€…ã«ã€è§£æ±ºç­–ãŒã‚ã‚‹ã“ã¨ã‚’æç¤ºã™ã‚‹
            - **æ–‡å­—æ•°**: 32æ–‡å­—å‰å¾Œï¼ˆæœ€å¤§40æ–‡å­—ï¼‰
            - **å¿…é ˆè¦ç´ **:
                1. **ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰**: ã€Œ{keyword}ã€ã‚’å«ã‚ã‚‹ã€‚
                2. **èª²é¡Œè§£æ±º**: ã€Œèª¤å‡ºè·é˜²æ­¢ã€ã€Œã‚³ã‚¹ãƒˆå‰Šæ¸›ã€ãªã©ã€å…·ä½“çš„ãªåŠ¹æœã‚’ã‚¢ãƒ”ãƒ¼ãƒ«ã€‚
                3. **å®Ÿè·µæ€§**: ã€Œäº‹ä¾‹ã‚ã‚Šã€ã€Œæ‰‹é †å…¬é–‹ã€ãªã©ã€ãƒã‚¦ãƒã‚¦ãŒå¾—ã‚‰ã‚Œã‚‹ã“ã¨ã‚’ç¤ºã™ã€‚
            
            ## ã‚¿ã‚¤ãƒˆãƒ«æ§‹æˆã®ãƒ’ãƒ³ãƒˆï¼ˆæŸ”è»Ÿã«ç™ºæƒ³ã—ã¦ãã ã•ã„ï¼‰
            - **Before/Afterå‹**: èª¤å‡ºè·ãŒã‚¼ãƒ­ã«ï¼{keyword}ã‚’æ´»ç”¨ã—ãŸæ¤œå“ãƒ•ãƒ­ãƒ¼æ”¹å–„äº‹ä¾‹
            - **ãƒã‚¦ãƒã‚¦å‹**: {keyword}ã§ç‰©æµã‚³ã‚¹ãƒˆã‚’20%å‰Šæ¸›ã—ãŸã€Œ3ã¤ã®ç§˜ç­–ã€ã¨ã¯ï¼Ÿ
            - **å®Ÿè·µã‚¬ã‚¤ãƒ‰å‹**: æ˜æ—¥ã‹ã‚‰ä½¿ãˆã‚‹ï¼{keyword}ã®å°å…¥æ‰‹é †ã¨é‹ç”¨ãƒãƒ‹ãƒ¥ã‚¢ãƒ«
            
            å˜ãªã‚‹è§£èª¬ã§ã¯ãªãã€ã€Œã©ã†ã™ã‚Œã°è§£æ±ºã§ãã‚‹ã‹ã€ãŒä¼ã‚ã‚‹ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªè¨€è‘‰ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚
            
            ## æ³¨æ„ç‚¹   
            - ä¿¡é ¼æ„Ÿã‚’ä¸ãˆã‚‹ãŸã‚è‡ªåˆ†ã‹ã‚‰ç‰©æµã‚¨ãƒãƒ³ã‚¸ã‚§ãƒªã‚¹ãƒˆã§ã™ã¨åä¹—ã‚‰ãªã„ã“ã¨
            """,
            
            "news": f"""
            {context_section}ã‚ãªãŸã¯ç‰©æµæ¥­ç•Œã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚³ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚¿ãƒ¼ã§ã‚ã‚Šã€SEOã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ©ã‚¤ã‚¿ãƒ¼ã§ã™ã€‚
            ä»¥ä¸‹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«é–¢ã™ã‚‹ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚„ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’ã€èª­è€…ï¼ˆç‰©æµé–¢ä¿‚è€…ï¼‰ã®é–¢å¿ƒã«å¼·ãè¨´æ±‚ã™ã‚‹ã‚ˆã†ã«è§£èª¬ã—ã¦ãã ã•ã„ã€‚
            
            ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: {keyword}
            
            ## ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
            - æ¥­ç•Œå‹•å‘ã‚’ã‚­ãƒ£ãƒƒãƒã‚¢ãƒƒãƒ—ã—ãŸã„çµŒå–¶å±¤ã€ç¾å ´ãƒªãƒ¼ãƒ€ãƒ¼
            
            ## æ§‹æˆæ¡ˆ
            1. **å°å…¥**: 
               - ã€é€Ÿå ±ãƒ»ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆã€‘ã€Œä»Šãªãœè©±é¡Œãªã®ã‹ã€ã€Œæ¥­ç•Œã«ã©ã‚“ãªè¡æ’ƒãŒã‚ã‚‹ã‹ã€ã‚’å†’é ­ã§ç«¯çš„ã«ä¼ãˆã‚‹ï¼ˆLEADæ–‡ï¼‰
            2. **ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®èƒŒæ™¯ãƒ»è©³ç´°**: 
               - äº‹å®Ÿé–¢ä¿‚ã‚’æ•´ç†ï¼ˆ5W1Hï¼‰
            3. **æ¥­ç•Œã¸ã®å…·ä½“çš„ãªå½±éŸ¿**: 
               - é‹é€ã€å€‰åº«ã€ãƒ¡ãƒ¼ã‚«ãƒ¼ãªã©ã€å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¸ã®å½±éŸ¿
            4. **LogiShiftã®è¦–ç‚¹ï¼ˆç‹¬è‡ªè€ƒå¯Ÿï¼‰**: 
               - å˜ãªã‚‹äº‹å®Ÿã®ç¾…åˆ—ã§ã¯ãªãã€ã€Œä»Šå¾Œã©ã†ãªã‚‹ã‹ã€ã€Œä¼æ¥­ã¯ã©ã†å‹•ãã¹ãã‹ã€ã®äºˆæ¸¬ã¨æè¨€
            5. **ã¾ã¨ã‚**: æ˜æ—¥ã‹ã‚‰æ„è­˜ã™ã¹ãã“ã¨
            
            ## åŸ·ç­†ãƒ«ãƒ¼ãƒ«
            - **ç‹¬è‡ªæ€§**: ä¸€èˆ¬çš„ãªãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚µã‚¤ãƒˆã¨å·®åˆ¥åŒ–ã™ã‚‹ãŸã‚ã€ã€ŒLogiShiftã®è¦–ç‚¹ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ç‹¬è‡ªã®è€ƒå¯Ÿã‚„äºˆæ¸¬ã‚’å¿…ãšå…¥ã‚Œã‚‹ã“ã¨ã€‚
            - **SEO**: ãƒˆãƒ¬ãƒ³ãƒ‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«é–¢é€£ã™ã‚‹è¤‡åˆèªã‚’è‡ªç„¶ã«ç››ã‚Šè¾¼ã‚€ã€‚
            - **ä¿¡é ¼æ€§**: å…¬å¼ç™ºè¡¨ã‚„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ç©æ¥µçš„ã«å¼•ç”¨ã™ã‚‹ã€‚
            
            ## ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            - Markdownå½¢å¼
            - **è¦ç‚¹ã‚„æ™‚ç³»åˆ—ã¯Markdownãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½¿ç”¨ã—ã¦æ•´ç†ã™ã‚‹ï¼ˆã‚¹ãƒãƒ›ã§è¦‹ã‚„ã™ã„ã‚ˆã†åˆ—æ•°ã‚’çµã‚‹ï¼‰**
            - **ã€å³å®ˆã€‘ãƒ†ãƒ¼ãƒ–ãƒ«å†…ã§ã¯HTMLã‚¿ã‚°ç¦æ­¢ã€‚æ”¹è¡Œã¯å¥èª­ç‚¹ã§å¯¾å¿œã€‚**
            - 2500ã€œ3000æ–‡å­—ç¨‹åº¦
            
            ## ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆãƒ«ãƒ¼ãƒ«
            - **ç›®çš„**: æ¤œç´¢çµæœï¼ˆSERPï¼‰ã§ã®ã‚¯ãƒªãƒƒã‚¯ç‡ï¼ˆCTRï¼‰æœ€å¤§åŒ–ã¨SEOé †ä½å‘ä¸Š
            - **æ–‡å­—æ•°**: 32æ–‡å­—å‰å¾Œï¼ˆã‚¹ãƒãƒ›ã§ã®è¦–èªæ€§è€ƒæ…®ã€‚æœ€å¤§40æ–‡å­—ï¼‰
            - **å¿…é ˆè¦ç´ **:
                1. **ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰**: ã€Œ{keyword}ã€ã®ä¸»è¦ãªè¦ç´ ï¼ˆè‹±èªã®å ´åˆã¯æ—¥æœ¬èªæ„è¨³ï¼‰ã‚’å¿…ãšå«ã‚ã‚‹ã€‚å¯èƒ½ãªé™ã‚Šå·¦å´ï¼ˆå†’é ­ï¼‰ã«é…ç½®ã™ã‚‹ã€‚
                2. **ãƒ™ãƒãƒ•ã‚£ãƒƒãƒˆ/ã‚¤ãƒ³ã‚µã‚¤ãƒˆ**: èª­è€…ãŒãã®è¨˜äº‹ã‚’èª­ã‚€ãƒ¡ãƒªãƒƒãƒˆï¼ˆã€Œ3ã¤ã®å¯¾ç­–ã€ã€Œå½±éŸ¿ã¾ã¨ã‚ã€ãªã©ï¼‰ã‚„ã€èˆˆå‘³ã‚’æƒ¹ãè¦ç´ ï¼ˆã€Œãªãœã€œãªã®ã‹ï¼Ÿã€ï¼‰ã‚’å…¥ã‚Œã‚‹ã€‚
            - **ç¦æ­¢äº‹é …**: 
                - ã€Œ{keyword}ã«ã¤ã„ã¦è§£èª¬ã€ã®ã‚ˆã†ãªå˜èª¿ãªç›´è¨³èª¿ã‚¿ã‚¤ãƒˆãƒ«ã€‚
                - è¨˜äº‹å†…å®¹ã¨ä¹–é›¢ã—ãŸé‡£ã‚Šã‚¿ã‚¤ãƒˆãƒ«ã€‚
            
            ## ã‚¿ã‚¤ãƒˆãƒ«æ§‹æˆã®ãƒ’ãƒ³ãƒˆï¼ˆã‚ãã¾ã§ä¾‹ã§ã™ã€‚ã“ã‚Œã«ç¸›ã‚‰ã‚Œãšæœ€é©ãªã‚¿ã‚¤ãƒˆãƒ«ã‚’è€ƒæ¡ˆã—ã¦ãã ã•ã„ï¼‰
            - **ç–‘å•æèµ·å‹**: ç‰©æµ2024å¹´å•é¡Œï½œãªãœé‹é€ä¼šç¤¾ã®å€’ç”£ãŒæ€¥å¢—ã—ã¦ã„ã‚‹ã®ã‹ï¼Ÿ
            - **ç¶²ç¾…ãƒ»ã¾ã¨ã‚å‹**: ã€å¾¹åº•è§£èª¬ã€‘ãƒˆãƒ©ãƒƒã‚¯Gãƒ¡ãƒ³ã¨ã¯ï¼Ÿè·ä¸»ãŒçŸ¥ã£ã¦ãŠãã¹ã3ã¤ã®å¯¾ç­–
            - **é€Ÿå ±ãƒ»ãƒˆãƒ¬ãƒ³ãƒ‰å‹**: Amazonã®ç‰©æµæˆ¦ç•¥ã«ç•°å¤‰ï½œè‡ªå‹•åŒ–ã®æ¬¡ã«æ¥ã‚‹ã€Œæ–°ãŸãªæ³¢ã€ã¨ã¯
            - **ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ˜ç¤ºå‹**: ä¸­å°é‹é€ä¼šç¤¾ã®çµŒå–¶è€…ã¸ï½œä»Šã™ãå§‹ã‚ã‚‹ã¹ãDXã®ç¬¬ä¸€æ­©
            
            ã“ã‚Œã‚‰ã®è¦ç´ ã‚’çµ„ã¿åˆã‚ã›ã€ãã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚„ãƒˆãƒ”ãƒƒã‚¯ã«æœ€ã‚‚é©ã—ãŸã€ã‚¯ãƒªãƒƒã‚¯ã—ãŸããªã‚‹ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
            ## æ³¨æ„ç‚¹
            - ä¿¡é ¼æ„Ÿã‚’ä¸ãˆã‚‹ãŸã‚è‡ªåˆ†ã‹ã‚‰ç‰©æµã‚¨ãƒãƒ³ã‚¸ã‚§ãƒªã‚¹ãƒˆã§ã™ã¨åä¹—ã‚‰ãªã„ã“ã¨
            """,
            
            "global": f"""
            {context_section}ã‚ãªãŸã¯ç‰©æµæ¥­ç•Œã®æµ·å¤–ãƒˆãƒ¬ãƒ³ãƒ‰ã‚¦ã‚©ãƒƒãƒãƒ£ãƒ¼ï¼ˆSEOãƒ©ã‚¤ã‚¿ãƒ¼ï¼‰ã§ã™ã€‚
            ä»¥ä¸‹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«é–¢é€£ã™ã‚‹æµ·å¤–ã®æœ€æ–°äº‹ä¾‹ã‚„ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’ã€æ—¥æœ¬ã®ç‰©æµä¼æ¥­ãŒå‚è€ƒã«ã§ãã‚‹å½¢ã§è§£èª¬ã—ã¦ãã ã•ã„ã€‚
            
            ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: {keyword}
            
            ## ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
            - ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ±‚ã‚ã‚‹çµŒå–¶å±¤ã€æ–°è¦äº‹æ¥­æ‹…å½“è€…
            - æµ·å¤–ã®å…ˆé€²äº‹ä¾‹ã‹ã‚‰ãƒ’ãƒ³ãƒˆã‚’å¾—ãŸã„DXæ¨é€²æ‹…å½“è€…
            
            ## æ§‹æˆæ¡ˆ
            1. **å°å…¥**: 
               - ã€Why Japan?ã€‘ãªãœä»Šã€æ—¥æœ¬ä¼æ¥­ãŒã“ã®æµ·å¤–ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’çŸ¥ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã‹ã‚’æç¤º
            2. **æµ·å¤–ã®æœ€æ–°å‹•å‘**: ç±³å›½ãƒ»ä¸­å›½ãƒ»æ¬§å·ãªã©ã§ä½•ãŒèµ·ãã¦ã„ã‚‹ã‹ï¼ˆå…·ä½“çš„ãªå¸‚å ´ãƒ‡ãƒ¼ã‚¿ãªã©ï¼‰
            3. **å…ˆé€²äº‹ä¾‹ï¼ˆã‚±ãƒ¼ã‚¹ã‚¹ã‚¿ãƒ‡ã‚£ï¼‰**: 
               - ç‰¹å®šã®ä¼æ¥­ã‚„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å–ã‚Šä¸Šã’ã€æˆåŠŸè¦å› ã‚’æ·±æ˜ã‚Š
            4. **æ—¥æœ¬ã¸ã®ç¤ºå”†**: 
               - æµ·å¤–ã®äº‹ä¾‹ã‚’æ—¥æœ¬å›½å†…ã«é©ç”¨ã™ã‚‹å ´åˆã®ãƒã‚¤ãƒ³ãƒˆã‚„éšœå£
               - æ—¥æœ¬ä¼æ¥­ãŒä»Šã™ãçœŸä¼¼ã§ãã‚‹ã“ã¨
            5. **ã¾ã¨ã‚**: å°†æ¥ã®å±•æœ›
            
            ## åŸ·ç­†ãƒ«ãƒ¼ãƒ«
            - **å…·ä½“æ€§**: å›½åã€ä¼æ¥­åã€å…·ä½“çš„ãªæ•°å­—ï¼ˆãƒ‰ãƒ«/å…ƒãªã©ï¼‰ã‚’å‡ºã—ã¦ãƒªã‚¢ãƒªãƒ†ã‚£ã‚’æŒãŸã›ã‚‹ã€‚
            - **æ—¥æœ¬ãƒ­ãƒ¼ã‚«ãƒ©ã‚¤ã‚º**: å˜ãªã‚‹ç¿»è¨³è¨˜äº‹ã«ã›ãšã€ã€Œæ—¥æœ¬ã ã¨ã©ã†ãªã‚‹ã‹ã€ã¨ã„ã†è¦–ç‚¹ã‚’å¿…ãšå…¥ã‚Œã‚‹ï¼ˆä¾‹: ã€Œæ—¥æœ¬ã®å•†ç¿’æ…£ã¨ã¯ç•°ãªã‚‹ãŒ...ã€ï¼‰ã€‚
            - **SEO**: ã€Œæµ·å¤–ç‰©æµã€ã€Œç‰©æµDX äº‹ä¾‹ã€ãªã©ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢ã•ã‚Œã‚‹ã“ã¨ã‚’æ„è­˜ã€‚
            
            ## ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            - Markdownå½¢å¼
            - **å›½åˆ¥ã®æ¯”è¼ƒã‚„äº‹ä¾‹ã®ä¸€è¦§ã¯Markdownãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ï¼ˆã‚¹ãƒãƒ›æœ€é©åŒ–: åˆ—æ•°ã‚’çµã‚‹ï¼‰**
            - **ã€å³å®ˆã€‘ãƒ†ãƒ¼ãƒ–ãƒ«å†…ã§ã¯HTMLã‚¿ã‚°ç¦æ­¢ã€‚æ”¹è¡Œã¯å¥èª­ç‚¹ã§å¯¾å¿œã€‚**
            - 3500æ–‡å­—ç¨‹åº¦
            
            ## ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆãƒ«ãƒ¼ãƒ«
            - **ç›®çš„**: æ—¥æœ¬ã®èª­è€…ãŒã€Œè‡ªåˆ†ã”ã¨ã€ã¨ã—ã¦æ‰ãˆã€ã‚¯ãƒªãƒƒã‚¯ã—ãŸããªã‚‹ã‚¿ã‚¤ãƒˆãƒ«ã®ä½œæˆ
            - **æ–‡å­—æ•°**: 32æ–‡å­—å‰å¾Œï¼ˆæœ€å¤§40æ–‡å­—ï¼‰
            - **ç¿»è¨³æ–¹é‡**: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€Œ{keyword}ã€ãŒè‹±èªã®å ´åˆã¯ã€ç›´è¨³ã›ãšã€ãã®æœ¬è³ªã‚’è¡¨ã™æ—¥æœ¬èªï¼ˆæ„è¨³ï¼‰ã‚’ã‚¿ã‚¤ãƒˆãƒ«ã«çµ„ã¿è¾¼ã‚€ã“ã¨ã€‚
            - **è¦–ç‚¹**: ã€Œæµ·å¤–ã®è©±ã€ã§çµ‚ã‚ã‚‰ã›ãšã€ã€Œæ—¥æœ¬ä¼æ¥­ã«ã¨ã£ã¦ã®å­¦ã³ã€ã€Œæ¬¡ã«æ¥ã‚‹ãƒˆãƒ¬ãƒ³ãƒ‰ã€ã¨ã„ã†è¦–ç‚¹ã‚’ç››ã‚Šè¾¼ã‚€ã€‚
            
            ## ã‚¿ã‚¤ãƒˆãƒ«æ§‹æˆã®ãƒ’ãƒ³ãƒˆï¼ˆã“ã‚Œã‚‰ã‚’å‚è€ƒã«æŸ”è»Ÿã«ç™ºæƒ³ã—ã¦ãã ã•ã„ï¼‰
            - **æ¨©å¨æ€§ãƒ»å®Ÿç¸¾**: ç±³å›½WalmartãŒæ¡ç”¨ï¼æœ€æ–°[æŠ€è¡“å]ã®åŠ¹æœã¨å°å…¥äº‹ä¾‹
            - **å…ˆé€²æ€§ãƒ»æœªæ¥**: ã€Œç‰©æµç‰ˆUberã€ã®æ¬¡ã¯ã“ã‚Œã ã€‚ä¸­å›½ã§æ€¥æ‹¡å¤§ã™ã‚‹[ã‚µãƒ¼ãƒ“ã‚¹å]ã®å…¨è²Œ
            - **æ—¥æœ¬ã¸ã®ç¤ºå”†**: æ—¥æœ¬æœªä¸Šé™¸ã®[ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰]ã¨ã¯ï¼Ÿ2025å¹´ã®ç‰©æµãƒˆãƒ¬ãƒ³ãƒ‰ã‚’å…ˆå–ã‚Š
            - **èª²é¡Œè§£æ±º**: èª¤å‡ºè·ã‚¼ãƒ­ã¸ã€‚æ¬§å·ã®ç‰©æµç¾å ´ã§é€²ã‚€ã€Œäººã‚’ä½¿ã‚ãªã„æ¤œå“ã€ã®å®Ÿæ…‹
            
            ä¸Šè¨˜ã®ãƒ’ãƒ³ãƒˆã‚’å‚è€ƒã«ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆèª­è€…ã®å¥½å¥‡å¿ƒã‚’åˆºæ¿€ã™ã‚‹ã‚¿ã‚¤ãƒˆãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚ã€Œã€œã«ã¤ã„ã¦è§£èª¬ã€ã¨ã„ã†è¡¨ç¾ã¯é¿ã‘ã€å…·ä½“çš„ã§é­…åŠ›çš„ãªè¨€è‘‰ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚
            ## æ³¨æ„ç‚¹
            - ä¿¡é ¼æ„Ÿã‚’ä¸ãˆã‚‹ãŸã‚è‡ªåˆ†ã‹ã‚‰ç‰©æµã‚¨ãƒãƒ³ã‚¸ã‚§ãƒªã‚¹ãƒˆã§ã™ã¨åä¹—ã‚‰ãªã„ã“ã¨
            """,

            "weekly_summary": f"""
            {context_section}ã‚ãªãŸã¯ç‰©æµæ¥­ç•Œã®å°‚é–€ãƒ¡ãƒ‡ã‚£ã‚¢ã€ŒLogiShiftã€ã®ç·¨é›†é•·ã§ã™ã€‚
            ä»Šé€±å…¬é–‹ã•ã‚ŒãŸä»¥ä¸‹ã®è¨˜äº‹ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã¨è¦ç´„ï¼‰ã‚’ã‚‚ã¨ã«ã€æ¥­ç•Œã®å‹•ãã‚’æ§‹é€ åŒ–ãƒ»æŠ½è±¡åŒ–ã—ã€æ·±ã„ç¤ºå”†ï¼ˆã‚¤ãƒ³ã‚µã‚¤ãƒˆï¼‰ã‚’æä¾›ã™ã‚‹ã€Œé€±é–“ã‚µãƒãƒªãƒ¼ã€ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
            
            ## å¯¾è±¡æœŸé–“
            - ç›´è¿‘1é€±é–“
            
            ## ã‚¿ãƒ¼ã‚²ãƒƒãƒˆèª­è€…
            - çµŒå–¶å±¤ã€ç‰©æµéƒ¨é–€é•·ã€DXæ¨é€²ãƒªãƒ¼ãƒ€ãƒ¼
            - å˜ãªã‚‹ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®ç¾…åˆ—ã§ã¯ãªãã€ã€Œãã®äº‹è±¡ãŒæ¥­ç•Œã«ã¨ã£ã¦ä½•ã‚’æ„å‘³ã™ã‚‹ã®ã‹ã€ã¨ã„ã†æ·±ã„è§£é‡ˆã‚’æ±‚ã‚ã¦ã„ã‚‹äºº
            
            ## æ§‹æˆæ¡ˆ
            1. **ä»Šé€±ã®æ½®æµï¼ˆThe Weekly Macro Viewï¼‰**:
               - å€‹åˆ¥ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’ä¿¯ç°ã—ã€ä»Šé€±ã®ç‰©æµæ¥­ç•ŒãŒã€Œã©ã®ã‚ˆã†ãªãƒ•ã‚§ãƒ¼ã‚ºã«ã‚ã£ãŸã‹ã€ã‚’æŠ½è±¡åŒ–ã—ã¦ä¸€è¨€ã§å®šç¾©ã™ã‚‹ã€‚ï¼ˆä¾‹ï¼šã€ŒAIã®å®Ÿè£…ãŒã€å®Ÿé¨“ã€ã‹ã‚‰ã€å®Ÿåˆ©ã€ã¸ã‚·ãƒ•ãƒˆã—ãŸ1é€±é–“ã€ãªã©ï¼‰
               - ãã®èƒŒæ™¯ã«ã‚ã‚‹æ¥­ç•Œæ§‹é€ ã®å¤‰åŒ–ã«ã¤ã„ã¦ç°¡æ½”ã«è§¦ã‚Œã‚‹ã€‚
            
            2. **æ¥­ç•Œæ§‹é€ ã®å¤‰åŒ–ã¨ç¤ºå”†ï¼ˆKey Movements & Insightsï¼‰**:
               - è¨˜äº‹ã‚’å˜ã«ãƒˆãƒ”ãƒƒã‚¯ã”ã¨ã«åˆ†é¡ã™ã‚‹ã®ã§ã¯ãªãã€ã€Œæ¥­ç•Œã®ã©ã®ã‚ˆã†ãªæ§‹é€ çš„å¤‰åŒ–ãƒ»å‹•ãã‹ã€ã¨ã„ã†è¦³ç‚¹ã§2ã€œ3ã¤ã®ã¾ã¨ã¾ã‚Šï¼ˆH2ï¼‰ã‚’ä½œã‚‹ã€‚
               - **æ§‹æˆè¦ç´ **:
                 - **ç¾è±¡ï¼ˆWhatï¼‰**: å…·ä½“çš„ã«ã©ã®ã‚ˆã†ãªãƒ‹ãƒ¥ãƒ¼ã‚¹ãŒã‚ã£ãŸã‹ï¼ˆè¨˜äº‹ãƒªãƒ³ã‚¯å¿…é ˆï¼‰ã€‚
                 - **æ·±å±¤ï¼ˆWhy/So Whatï¼‰**: ãªãœãã®å‹•ããŒèµ·ãã¦ã„ã‚‹ã®ã‹ï¼Ÿãã“ã‹ã‚‰èª­ã¿å–ã‚Œã‚‹æ¥­ç•Œã®èª²é¡Œã‚„ãƒãƒ£ãƒ³ã‚¹ã¯ä½•ã‹ï¼Ÿèª­è€…ã¯ã©ã†æ‰ãˆã‚‹ã¹ãã‹ï¼Ÿã¨ã„ã†ã€Œç‹¬è‡ªã®ç¤ºå”†ã€ã‚’å¿…ãšåŠ ãˆã‚‹ã€‚
               - **è¨˜äº‹ãƒªãƒ³ã‚¯**: é–¢é€£ã™ã‚‹è¨˜äº‹ã¸ã®ãƒªãƒ³ã‚¯ï¼ˆ`[è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«](URL)`ï¼‰ã‚’æ–‡è„ˆã®ä¸­ã§è‡ªç„¶ã«ã€ã‹ã¤å¿…ãšåŸ‹ã‚è¾¼ã‚€ã“ã¨ã€‚
            
            3. **æ¥é€±ä»¥é™ã®è¦–ç‚¹ï¼ˆStrategic Outlookï¼‰**:
               - ä»Šé€±ã®å‹•ãã‚’è¸ã¾ãˆã€æ¥é€±ä»¥é™ã€èª­è€…ãŒæ³¨ç›®ã™ã¹ãå…·ä½“çš„ãªãƒã‚¤ãƒ³ãƒˆã‚’æè¨€ã™ã‚‹ã€‚
               - æŠ½è±¡çš„ãªè©±ã§çµ‚ã‚ã‚‰ã›ãšã€ã€Œã©ã®æŠ€è¡“ã®é€²å±•ã‚’è¦‹ã‚‹ã¹ãã‹ã€ã€Œã©ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆä¼æ¥­ç¾¤ï¼‰ã®å‹•ãã‚’æ³¨è¦–ã™ã¹ãã‹ã€ã€Œè¦åˆ¶ã‚„å¸‚å ´ç’°å¢ƒã¯ã©ã†å‹•ãã‹ã€ãªã©ã€å…·ä½“çš„ãªã€Œã‚¦ã‚©ãƒƒãƒãƒã‚¤ãƒ³ãƒˆã€ã‚’æç¤ºã™ã‚‹ã€‚
            
            ## åŸ·ç­†ãƒ«ãƒ¼ãƒ«
            - **æ€è€ƒã®æ·±ã•**: è¨˜äº‹ã®è¦ç´„ã§çµ‚ã‚ã‚‰ã›ãªã„ã€‚ã€Œã¤ã¾ã‚Šã€ã“ã‚Œã¯ã€‡ã€‡ã¨ã„ã†å¤§ããªæµã‚Œã®ä¸€éƒ¨ã§ã‚ã‚‹ã€ã¨ã„ã†æ§‹é€ åŒ–ãƒ»æŠ½è±¡åŒ–ã‚’è¡Œã†ã“ã¨ã€‚
            - **ãƒˆãƒ¼ãƒ³ï¼†ãƒãƒŠãƒ¼**: çŸ¥çš„ã§æ´å¯Ÿã«æº€ã¡ãŸãƒˆãƒ¼ãƒ³ã€‚è©•è«–å®¶ã«ãªã‚‰ãšã€å®Ÿå‹™å®¶ã«å¯„ã‚Šæ·»ã£ãŸè¦–ç‚¹ã‚’æŒã¤ã€‚
            - **ãƒªãƒ³ã‚¯ï¼ˆæœ€é‡è¦ï¼‰**: 
                - **å¯èƒ½ãªé™ã‚Šå¤šãã®è¨˜äº‹ã‚’ç´¹ä»‹ã™ã‚‹ã“ã¨ã€‚** å°‘ãªãã¨ã‚‚10è¨˜äº‹ä»¥ä¸Šã¸ã®è¨€åŠãƒ»ãƒªãƒ³ã‚¯ã‚’ç›®æŒ‡ã™ã€‚
                - å˜ã«ãƒªã‚¹ãƒˆåŒ–ã™ã‚‹ã®ã§ã¯ãªãã€æ–‡è„ˆã®ä¸­ã§è‡ªç„¶ã«è¤‡æ•°ã®è¨˜äº‹ã‚’å¼•ç”¨ã™ã‚‹ã€‚ï¼ˆä¾‹ï¼šã€ŒAç¤¾ï¼ˆãƒªãƒ³ã‚¯ï¼‰ã‚„Bç¤¾ï¼ˆãƒªãƒ³ã‚¯ï¼‰ã®äº‹ä¾‹ã«è¦‹ã‚‰ã‚Œã‚‹ã‚ˆã†ã«...ã€ï¼‰
                - ã™ã¹ã¦ã®ä¸»å¼µã®æ ¹æ‹ ã¨ã—ã¦ã€æä¾›ã•ã‚ŒãŸè¨˜äº‹ã¸ã®ãƒªãƒ³ã‚¯ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã€‚
            
            ## ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            - Markdownå½¢å¼
            - è¨˜äº‹ãƒªãƒ³ã‚¯å¿…é ˆ
            - è¨˜äº‹é‡ã¯ã—ã£ã‹ã‚Šèªã‚‹ãŸã‚ **4000ã€œ5000æ–‡å­—ç¨‹åº¦** ã‚’ç›®æŒ‡ã™ã€‚
            
            ## ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆãƒ«ãƒ¼ãƒ«
            - **ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**: ã€é€±é–“ã‚µãƒãƒªãƒ¼ã€‘MM/DDã€œMM/DDï½œ[ä»Šé€±ã®æœ€å¤§ã®æ½®æµãƒ»æŠ½è±¡åŒ–ã—ãŸãƒ†ãƒ¼ãƒ]
            - **ä¾‹**: ã€é€±é–“ã‚µãƒãƒªãƒ¼ã€‘12/13ã€œ12/20ï½œã€Œç‚¹ã€ã®DXã‹ã‚‰ã€Œç·šã€ã®é€£æºã¸ã€ç‰©æµæ§‹é€ æ”¹é©ã®èƒå‹•
            """
        }
        
        prompt = prompts.get(article_type, prompts["know"])
        
        if extra_instructions:
            prompt += f"\n\n{extra_instructions}\n"
        
        # Add common formatting instruction
        prompt += """
        
        ## å‡ºåŠ›å½¢å¼
        å¿…ãšä»¥ä¸‹ã®å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š
        
        1è¡Œç›®: # [ç”Ÿæˆã—ãŸã‚¿ã‚¤ãƒˆãƒ«]
        2è¡Œç›®: ç©ºè¡Œ
        3è¡Œç›®ä»¥é™: è¨˜äº‹æœ¬æ–‡ï¼ˆå°å…¥ã‹ã‚‰å§‹ã‚ã‚‹ï¼‰
        
        **è¦‹å‡ºã—ãƒ¬ãƒ™ãƒ«:**
        - ã‚¿ã‚¤ãƒˆãƒ«: # (H1) â† è¨˜äº‹ã®ä¸»é¡Œ
        - å¤§è¦‹å‡ºã—: ## (H2) â† è¨˜äº‹ã®ä¸»è¦ãªæ§‹æˆè¦ç´ ï¼ˆç« ï¼‰
        - ä¸­è¦‹å‡ºã—: ### (H3) â† ç« ã‚’æ§‹æˆã™ã‚‹å…·ä½“çš„ãªãƒˆãƒ”ãƒƒã‚¯ï¼ˆç¯€ï¼‰
        - å°è¦‹å‡ºã—: #### (H4) â† ãƒˆãƒ”ãƒƒã‚¯ã®è©³ç´°ã€‚æƒ…å ±ã®ç²’åº¦ã‚’ç´°ã‹ãã—ã€å¯èª­æ€§ã‚’é«˜ã‚ã‚‹ãŸã‚ã«æ´»ç”¨ã™ã‚‹ã€‚
        
        **ã€é‡è¦ã€‘Markdownè¨˜è¿°ãƒ«ãƒ¼ãƒ«:**
        - **ãƒªã‚¹ãƒˆï¼ˆç®‡æ¡æ›¸ãï¼‰ã®å‰ã«ã¯å¿…ãšç©ºè¡Œã‚’å…¥ã‚Œã‚‹ã“ã¨ã€‚** ç©ºè¡ŒãŒãªã„ã¨æ­£ã—ããƒªã‚¹ãƒˆã¨ã—ã¦èªè­˜ã•ã‚Œãªã„ãŸã‚å³å®ˆã™ã‚‹ã€‚
        - **ãƒã‚¹ãƒˆï¼ˆå…¥ã‚Œå­ï¼‰ã—ãŸãƒªã‚¹ãƒˆã®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã¯å¿…ãšåŠè§’ã‚¹ãƒšãƒ¼ã‚¹4ã¤ï¼ˆ4 spacesï¼‰ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã€‚** 2ã‚¹ãƒšãƒ¼ã‚¹ã§ã¯æ§‹é€ ãŒå´©ã‚Œã‚‹å ´åˆãŒã‚ã‚‹ã€‚
        
        **ã€é‡è¦ã€‘è¦‹å‡ºã—ã®ç¦æ­¢äº‹é …:**
        - **ã€Œå…·ä½“çš„ãªåŠ¹æœã€ã€Œãƒ¡ãƒªãƒƒãƒˆã€ã€Œãƒã‚¤ãƒ³ãƒˆã€ã¨ã„ã£ãŸæ±ç”¨çš„ãªå˜èªã ã‘ã®è¦‹å‡ºã—ã‚’ã€H3ã‚„H4ã§ç¹°ã‚Šè¿”ã—ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’ç¦æ­¢ã™ã‚‹ã€‚**
        - OKä¾‹: `#### è‡ªå‹•è¦‹ç©ã‚‚ã‚Šã«ã‚ˆã‚‹ã‚³ã‚¹ãƒˆå‰Šæ¸›`
        - NGä¾‹: `#### å…·ä½“çš„ãªåŠ¹æœ`
        - ç›®æ¬¡ã‚’è¦‹ãŸã ã‘ã§å†…å®¹ãŒä¼ã‚ã‚‹å…·ä½“çš„ãªè¦‹å‡ºã—ã«ã™ã‚‹ã“ã¨ã€‚
        
        ä¾‹:
        # WMSï¼ˆå€‰åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼‰ã¨ã¯ï¼Ÿå°å…¥ãƒ¡ãƒªãƒƒãƒˆã¨é¸ã³æ–¹ã‚’ç‰©æµæ‹…å½“è€…å‘ã‘ã«å¾¹åº•è§£èª¬
        
        ç‰©æµå€‰åº«ã®ç¾å ´ã§åƒãæ‹…å½“è€…ã‚„å€‰åº«ç®¡ç†è€…ã®çš†æ§˜ãªã‚‰...
        
        ## WMSã¨ã¯ä½•ã‹ï¼Ÿ
        
        å€‰åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆWMSï¼‰ã¯...
        
        ### WMSã®ä¸»ãªæ©Ÿèƒ½
        
        ...
        """
        
        try:
            response = self._retry_request(
                self.client.models.generate_content,
                model='gemini-3-pro-preview',
                contents=prompt
            )
            return response.text
        except Exception as e:
            print(f"Error generating content: {e}")
            return None

    def generate_image(self, prompt, output_path, aspect_ratio="16:9"):
        """
        Generate an image using Gemini 2.5 Flash Image (Primary) or Imagen 3.0 (Fallback).
        """
        # 1. Try Gemini 2.5 Flash Image (API Key supported)
        try:
            print(f"Generating image with Gemini 2.5 Flash Image for prompt: {prompt}")
            
            # Use google-genai SDK (v1beta) for API Key support and aspect ratio control
            # We need a dedicated client for v1beta to ensure aspect_ratio works
            client_v1beta = genai.Client(api_key=self.api_key, vertexai=False, http_options={'api_version': 'v1beta'})
            
            response = client_v1beta.models.generate_content(
                model='gemini-2.5-flash-image',
                contents=prompt,
                config=types.GenerateContentConfig(
                    response_modalities=["IMAGE"],
                    image_config=types.ImageConfig(
                        aspect_ratio=aspect_ratio,
                    )
                )
            )
            
            # Extract image from response (Gemini 2.5 Flash)
            if response.parts:
                for part in response.parts:
                    # Check if part has inline_data (image)
                    if part.inline_data is not None:
                        image_bytes = part.inline_data.data
                        with open(output_path, 'wb') as f:
                            f.write(image_bytes)
                        print(f"Image saved to: {output_path}")
                        return output_path
            
            print("No image found in Gemini 2.5 response, trying fallback...")
            
        except Exception as e:
            print(f"Gemini 2.5 Flash Image failed ({e}), falling back to Imagen 3.0...")

        # 2. Fallback to Imagen 3.0 (Vertex AI only)
        try:
            print(f"Generating image with Imagen 3.0 (Fallback) for prompt: {prompt}")
            
            response = self._retry_request(
                self.client.models.generate_images,
                model='imagen-3.0-generate-001',
                prompt=prompt,
                config={
                    'aspect_ratio': aspect_ratio
                }
            )
            
            # Extract image from response (Imagen 3.0)
            if response.generated_images:
                image_bytes = response.generated_images[0].image.image_bytes
                with open(output_path, 'wb') as f:
                    f.write(image_bytes)
                print(f"Image saved to: {output_path}")
                return output_path
            
            print("No image generated in Imagen 3.0 response.")
            return None
                
        except Exception as e:
            print(f"Failed to generate image with Imagen 3.0: {e}")
            return None


    def generate_image_prompt(self, title, content_summary, article_type="know"):
        """
        Generate an optimized English image prompt based on article title and content.
        
        Args:
            title: Article title
            content_summary: Brief summary or first paragraph of the article
            article_type: Type of article (know, buy, do, news, global)
        
        Returns:
            English image prompt optimized for Imagen 3.0
        """
        prompt = f"""
        You are an expert at creating image generation prompts for Imagen 3.0.
        
        Based on the following article information, create a detailed English image prompt that:
        1. Captures the main theme and context of the article
        2. Is specific and descriptive (not abstract)
        3. Focuses on logistics/warehouse/supply chain context
        4. Is photorealistic and professional
        5. Avoids text, human faces, or complex diagrams
        
        Article Title: {title}
        Article Type: {article_type}
        Content Summary: {content_summary[:500]}
        
        Generate a single, detailed English image prompt (max 100 words) that would create a compelling hero image for this article.
        Output ONLY the prompt text, no explanations.
        """
        
        try:
            response = self._retry_request(
                self.client.models.generate_content,
                model='gemini-3-pro-preview',
                contents=prompt
            )
            return response.text.strip()
        except Exception as e:
            print(f"Error generating image prompt: {e}")
            # Fallback to simple prompt
            return f"Professional logistics warehouse scene related to {title}, photorealistic, high quality, 4k"

    def classify_content(self, content):
        """
        Classify the article content into categories and tags.
        """
        prompt = f"""
        You are an expert content classifier for a logistics media site.
        Analyze the following article content and classify it.

        Content:
        {content[:3000]}... (truncated)

        Output JSON format:
        {{
            "category": "one of [warehouse-management, logistics-dx, material-handling, 2024-problem, cost-reduction, global-logistics]",
            "industry_tags": ["list", "of", "relevant", "industries", "e.g.", "manufacturing", "retail", "ecommerce", "3pl-warehouse", "transportation"],
            "theme_tags": ["list", "of", "relevant", "themes", "e.g.", "labor-shortage", "automation", "cost-reduction", "quality-improvement", "safety", "environment"]
        }}
        """
        
        try:
            response = self._retry_request(
                self.client.models.generate_content,
                model='gemini-3-pro-preview',
                contents=prompt,
                config=types.GenerateContentConfig(
                    response_mime_type="application/json"
                )
            )
            import json
            return json.loads(response.text)
        except Exception as e:
            print(f"Classification failed: {e}")
            import traceback
            traceback.print_exc()
            return None

    def generate_static_page(self, page_type):
        """
        Generate static page content (privacy policy, about, contact).
        
        Args:
            page_type: "privacy", "about", or "contact"
        
        Returns:
            Generated markdown content
        """
        prompts = {
            "privacy": """
            ã‚ãªãŸã¯æ³•å‹™ã«è©³ã—ã„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ©ã‚¤ã‚¿ãƒ¼ã§ã™ã€‚
            ä»¥ä¸‹ã®æƒ…å ±ã‚’åŸºã«ã€æ—¥æœ¬ã®å€‹äººæƒ…å ±ä¿è­·æ³•ã«æº–æ‹ ã—ãŸãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
            
            ã€ã‚µã‚¤ãƒˆæƒ…å ±ã€‘
            - ã‚µã‚¤ãƒˆå: LogiShiftï¼ˆãƒ­ã‚¸ã‚·ãƒ•ãƒˆï¼‰
            - é‹å–¶è€…: LogiShiftç·¨é›†éƒ¨
            - è¨­ç«‹: 2025å¹´11æœˆ
            - ç›®çš„: ç‰©æµæ¥­ç•Œã®DXæ¨é€²ãƒ»èª²é¡Œè§£æ±ºã«é–¢ã™ã‚‹æƒ…å ±æä¾›
            - ä½¿ç”¨æŠ€è¡“: Googleã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã€Cookie
            - ãŠå•ã„åˆã‚ã›: info@logishift.jp
            
            ## å«ã‚ã‚‹ã¹ãé …ç›®
            1. å€‹äººæƒ…å ±ã®å–ã‚Šæ‰±ã„ã«ã¤ã„ã¦
            2. åé›†ã™ã‚‹æƒ…å ±ã®ç¨®é¡ï¼ˆã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã€Cookieç­‰ï¼‰
            3. åˆ©ç”¨ç›®çš„ï¼ˆã‚µã‚¤ãƒˆæ”¹å–„ã€çµ±è¨ˆåˆ†æç­‰ï¼‰
            4. ç¬¬ä¸‰è€…æä¾›ï¼ˆGoogleã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ç­‰ï¼‰
            5. Cookieãƒ»ã‚¢ã‚¯ã‚»ã‚¹è§£æãƒ„ãƒ¼ãƒ«ã«ã¤ã„ã¦
            6. å€‹äººæƒ…å ±ã®é–‹ç¤ºãƒ»è¨‚æ­£ãƒ»å‰Šé™¤ã«ã¤ã„ã¦
            7. ãŠå•ã„åˆã‚ã›å…ˆ
            8. åˆ¶å®šæ—¥ãƒ»æ”¹å®šæ—¥
            
            ## å‡ºåŠ›å½¢å¼
            - Markdownå½¢å¼ã§å‡ºåŠ›
            - è¦‹å‡ºã—ã¯H2ï¼ˆ##ï¼‰ã¨H3ï¼ˆ###ï¼‰ã‚’ä½¿ç”¨
            - ç®‡æ¡æ›¸ãã‚„è¡¨ã‚’é©å®œä½¿ç”¨
            - æ³•çš„ã«æ­£ç¢ºã§ã€ã‹ã¤èª­ã¿ã‚„ã™ã„æ–‡ç« 
            - æœ€å¾Œã«ã€Œåˆ¶å®šæ—¥: 2025å¹´11æœˆ1æ—¥ã€ã‚’è¨˜è¼‰
            
            ## æ³¨æ„ç‚¹
            - å°‚é–€ç”¨èªã¯åˆ†ã‹ã‚Šã‚„ã™ãèª¬æ˜
            - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©åˆ©ã‚’æ˜ç¢ºã«è¨˜è¼‰
            - é€£çµ¡å…ˆã‚’æ˜è¨˜
            """,
            
            "about": """
            ã‚ãªãŸã¯ã‚³ãƒ¼ãƒãƒ¬ãƒ¼ãƒˆã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å°‚é–€å®¶ã§ã™ã€‚
            ä»¥ä¸‹ã®æƒ…å ±ã‚’åŸºã«ã€LogiShiftã®é‹å–¶è€…æƒ…å ±ãƒšãƒ¼ã‚¸ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
            
            ã€ã‚µã‚¤ãƒˆæƒ…å ±ã€‘
            - ã‚µã‚¤ãƒˆå: LogiShiftï¼ˆãƒ­ã‚¸ã‚·ãƒ•ãƒˆï¼‰
            - é‹å–¶è€…: LogiShiftç·¨é›†éƒ¨
            - è¨­ç«‹: 2025å¹´11æœˆ
            - ãŠå•ã„åˆã‚ã›: info@logishift.jp
            
            ã€ãƒŸãƒƒã‚·ãƒ§ãƒ³ã€‘
            ç‰©æµæ¥­ç•Œã®èª²é¡Œè§£æ±ºã¨DXæ¨é€²ã«è²¢çŒ®ã—ã€æ¥­ç•ŒNo.1ã®SEOãƒ¡ãƒ‡ã‚£ã‚¢ã‚’ç›®æŒ‡ã™
            
            ã€ä¸»ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã€‘
            - ç‰©æµã‚³ã‚¹ãƒˆå‰Šæ¸›ã®ãƒã‚¦ãƒã‚¦
            - æœ€æ–°ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ï¼ˆWMS, RFID, ãƒãƒ†ãƒãƒ³ãªã©ï¼‰ã®è§£èª¬
            - 2024å¹´å•é¡Œãªã©ã®æ¥­ç•Œãƒˆãƒ¬ãƒ³ãƒ‰è§£èª¬
            - ç‰©æµDXã®æˆåŠŸäº‹ä¾‹ç´¹ä»‹
            
            ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆèª­è€…ã€‘
            ä¼æ¥­ã®ç‰©æµæ‹…å½“è€…ã€å€‰åº«ç®¡ç†è€…ã€çµŒå–¶å±¤
            
            ## å«ã‚ã‚‹ã¹ãé …ç›®
            1. LogiShiftã«ã¤ã„ã¦ï¼ˆã‚µã‚¤ãƒˆã®ç›®çš„ãƒ»ãƒ“ã‚¸ãƒ§ãƒ³ï¼‰
            2. åŸºæœ¬æƒ…å ±ï¼ˆã‚µã‚¤ãƒˆåã€é‹å–¶è€…ã€è¨­ç«‹å¹´ã€ãŠå•ã„åˆã‚ã›å…ˆï¼‰ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ã§
            3. ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ»ãƒ“ã‚¸ãƒ§ãƒ³
            4. ä¸»ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚«ãƒ†ã‚´ãƒªã®ç´¹ä»‹
            5. æƒ³å®šèª­è€…
            6. ãŠå•ã„åˆã‚ã›å…ˆ
            
            ## å‡ºåŠ›å½¢å¼
            - Markdownå½¢å¼ã§å‡ºåŠ›
            - è¦‹å‡ºã—ã¯H2ï¼ˆ##ï¼‰ã¨H3ï¼ˆ###ï¼‰ã‚’ä½¿ç”¨
            - åŸºæœ¬æƒ…å ±ã¯Markdownãƒ†ãƒ¼ãƒ–ãƒ«ã§æ•´ç†
            - è¦ªã—ã¿ã‚„ã™ãã€ä¿¡é ¼æ„Ÿã®ã‚ã‚‹æ–‡ç« 
            - ç‰©æµæ¥­ç•Œã¸ã®ç†±æ„ãŒä¼ã‚ã‚‹å†…å®¹
            """,
            
            "contact": """
            ã‚ãªãŸã¯ã‚«ã‚¹ã‚¿ãƒãƒ¼ã‚µãƒãƒ¼ãƒˆã®å°‚é–€å®¶ã§ã™ã€‚
            ä»¥ä¸‹ã®æƒ…å ±ã‚’åŸºã«ã€LogiShiftã®ãŠå•ã„åˆã‚ã›ãƒšãƒ¼ã‚¸ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
            
            ã€ã‚µã‚¤ãƒˆæƒ…å ±ã€‘
            - ã‚µã‚¤ãƒˆå: LogiShiftï¼ˆãƒ­ã‚¸ã‚·ãƒ•ãƒˆï¼‰
            - é‹å–¶è€…: LogiShiftç·¨é›†éƒ¨
            - ãŠå•ã„åˆã‚ã›: info@logishift.jp
            - å¯¾å¿œæ™‚é–“: å¹³æ—¥ 10:00-18:00ï¼ˆåœŸæ—¥ç¥æ—¥ã‚’é™¤ãï¼‰
            
            ## å«ã‚ã‚‹ã¹ãé …ç›®
            1. ãŠå•ã„åˆã‚ã›ã«ã¤ã„ã¦ï¼ˆå°å…¥æ–‡ï¼‰
            2. ãŠå•ã„åˆã‚ã›æ–¹æ³•ï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰
            3. å¯¾å¿œæ™‚é–“
            4. ãŠå•ã„åˆã‚ã›å†…å®¹ã®ä¾‹ï¼ˆè¨˜äº‹ã®å†…å®¹ã€åºƒå‘Šæ²è¼‰ã€å–æä¾é ¼ãªã©ï¼‰
            5. è¿”ä¿¡ã¾ã§ã®ç›®å®‰æ™‚é–“
            6. æ³¨æ„äº‹é …ï¼ˆå€‹äººæƒ…å ±ã®å–ã‚Šæ‰±ã„ã€å–¶æ¥­ç›®çš„ã®å•ã„åˆã‚ã›ãªã©ï¼‰
            
            ## å‡ºåŠ›å½¢å¼
            - Markdownå½¢å¼ã§å‡ºåŠ›
            - è¦‹å‡ºã—ã¯H2ï¼ˆ##ï¼‰ã¨H3ï¼ˆ###ï¼‰ã‚’ä½¿ç”¨
            - ç®‡æ¡æ›¸ãã‚’é©å®œä½¿ç”¨
            - ä¸å¯§ã§åˆ†ã‹ã‚Šã‚„ã™ã„æ–‡ç« 
            - ãŠå•ã„åˆã‚ã›ã—ã‚„ã™ã„é›°å›²æ°—
            
            ## æ³¨æ„ç‚¹
            - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¿…ãšè¨˜è¼‰
            - å¯¾å¿œæ™‚é–“ã‚’æ˜è¨˜
            - ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã¸ã®ãƒªãƒ³ã‚¯ã‚’æ¡ˆå†…ï¼ˆã€Œè©³ã—ãã¯[ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼](/privacy-policy/)ã‚’ã”è¦§ãã ã•ã„ã€ï¼‰
            """
        }
        
        prompt = prompts.get(page_type)
        if not prompt:
            raise ValueError(f"Invalid page_type: {page_type}. Must be 'privacy', 'about', or 'contact'")
        
        try:
            response = self._retry_request(
                self.client.models.generate_content,
                model='gemini-3-pro-preview',
                contents=prompt
            )
            return response.text
        except Exception as e:
            print(f"Error generating static page: {e}")
            return None


    def generate_structured_summary(self, content):
        """
        Generate a structured JSON summary of the article for internal linking relevance.
        """
        prompt = f"""
        You are an expert content analyst. Analyze the following article and generate a structured summary in JSON format.
        This summary will be used by an AI system to identify relevant internal links.
        IMPORTANT: The content is Japanese, so the 'summary' and 'key_topics' MUST be written in Japanese.

        Article Content:
        {content[:4000]}... (truncated)

        Output JSON format (Strictly JSON only):
        {{
            "summary": "Detailed summary of the article content (300-500 chars) in Japanese. Mention specific methods, technologies, or case studies discussed.",
            "key_topics": ["list", "of", "specific", "sub-topics", "covered", "(in Japanese)"],
            "entities": ["list", "of", "companies", "products", "or", "tools", "mentioned", "(preserve original names)"]
        }}
        """
        
        try:
            response = self._retry_request(
                self.client.models.generate_content,
                model='gemini-3-pro-preview',
                contents=prompt,
                config=types.GenerateContentConfig(
                    response_mime_type="application/json"
                )
            )
            import json
            return json.loads(response.text)
        except Exception as e:
            print(f"Structured summary generation failed: {e}")
            return None

    def generate_sns_content(self, title, content, article_type="know"):
        """
        Generate engaging SNS (Twitter/X) post content.
        Output is JSON: {"hook": "...", "summary": "...", "hashtags": ["#tag1", ...]}
        """
        # Truncate content for efficiency
        truncated_content = content[:3000]
        
        prompt = f"""
        You are an expert social media manager for a logistics media site "LogiShift".
        Create an engaging X (Twitter) post content based on the following article.
        
        Target Audience: Logistics professionals, warehouse managers, executives.
        Goal: Maximize CTR (Click Through Rate) and engagement. Use "FOMO" (Fear Of Missing Out) or "High Benefit" appeal.

        Article Title: {title}
        Article Type: {article_type}
        Content (excerpt):
        {truncated_content}

        Requirements:
        1. **Hook**: A strong, catchy opening line. Use a question, a shocking fact, or a counter-intuitive statement. 
           - MUST include 1 relevant emoji at the beginning or end.
           - Max 50 chars.
        2. **Summary**: A compelling teaser. Do NOT just summarize("ã€œã«ã¤ã„ã¦è§£èª¬"). Explain "Why this matters" or "What they will lose by not reading".
           - Focus on benefits (cost down, efficiency up, risk avoidance).
           - Max 100 chars.
        3. **Hashtags**: 3-5 relevant hashtags.
           - **CRITICAL**: To maximize Impressions (Imp), PRIORITIZE using **specific proper nouns** (Company names, Product names, Technology names) mentioned in the article content over generic terms.
           - Example: Use "#Amazon" or "#RFID" instead of generic tags.

        4. Language: Japanese. 
        5. **Tone**: Professional but urgent/exciting. Avoid robotic or purely descriptive tone.

        Output JSON format (Strictly JSON only):
        {{
            "hook": "ğŸ˜± 2024å¹´å•é¡Œã€å®Ÿã¯ã¾ã é–“ã«åˆã†ï¼Ÿ",
            "summary": "ã€Œã‚‚ã†æ‰‹é…ã‚Œã€ã¨è«¦ã‚ã‚‹ã®ã¯æ—©ã„ã€‚ç¾å ´ãŒã™ãå–ã‚Šçµ„ã‚ã‚‹3ã¤ã®å³åŠ¹ç­–ã‚’å…¬é–‹ã€‚çŸ¥ã‚‰ãªã„ã¨æã™ã‚‹ç‰©æµDXã®æœ€å‰ç·šã¨ã¯ï¼Ÿ",
            "hashtags": ["#LogiShift", "#Amazon", "#RFID", "#ç‰©æµDX"]
        }}
        """
        
        try:
            response = self._retry_request(
                self.client.models.generate_content,
                model='gemini-3-pro-preview',
                contents=prompt,
                config=types.GenerateContentConfig(
                    response_mime_type="application/json"
                )
            )
            import json
            return json.loads(response.text)
        except Exception as e:
            print(f"SNS content generation failed: {e}")
            # Fallback
            return {
                "hook": f"ã€æ–°ç€è¨˜äº‹ã€‘{title}",
                "summary": "æœ€æ–°ã®ç‰©æµãƒˆãƒ¬ãƒ³ãƒ‰ã‚’è§£èª¬ã—ã¾ã—ãŸã€‚è©³ç´°ã¯ã“ã¡ã‚‰ã‚’ãƒã‚§ãƒƒã‚¯ï¼",
                "hashtags": ["#LogiShift", "#ç‰©æµ"]
            }

    def check_duplication(self, new_title, new_summary, existing_titles):
        """
        Check if a new article title semantically matches any existing titles.
        
        Args:
            new_title: The title of the potential new article
            new_summary: The summary of the potential new article
            existing_titles: List of existing article titles (WP posts + currently generated)
            
        Returns:
            The matching existing title if duplicate found, or None.
        """
        if not existing_titles:
            return None
            
        # Optimization: Don't check against massive lists if unnecessary.
        # But for now, we assume existing_titles is reasonably sized (e.g., < 50).
        
        prompt = f"""
        You are a duplicate content detector for a logistics news site.
        Determine if the "New Article" covers the **same specific news topic** as any of the "Existing Articles".
        
        Rule:
        - Return the EXACT title of the existing article ONLY if they are about the same specific news event or announcement.
        - If the new article is just a general topic match (e.g. both are about "RFID") but different specific news, return "None".
        - If the new article is a "Summary" or "Compilation" and the existing one is a single news, they are different -> return "None".
        - Different companies doing similar things are DIFFERENT -> return "None".
        - Same company doing the same thing (reported by different sources) are DUPLICATES -> return the existing title.
        
        New Article:
        Title: "{new_title}"
        Summary: "{new_summary}"
        
        Existing Articles:
        {json.dumps(existing_titles, ensure_ascii=False, indent=2)}
        
        Output JSON format:
        {{
            "is_duplicate": true/false,
            "duplicate_of": "Exact Title of Existing Article" (or null if false),
            "reason": "Brief explanation"
        }}
        """
        
        try:
            response = self._retry_request(
                self.client.models.generate_content,
                model='gemini-2.0-flash-exp',
                contents=prompt,
                config=types.GenerateContentConfig(
                    response_mime_type="application/json"
                )
            )
            result = json.loads(response.text)
            
            if result.get("is_duplicate"):
                print(f"Duplicate detected! '{new_title}' is duplicate of '{result.get('duplicate_of')}'")
                print(f"Reason: {result.get('reason')}")
                return result.get("duplicate_of")
            
            return None
            
        except Exception as e:
            print(f"Duplication check failed: {e}")
            return None

if __name__ == "__main__":
    # Test generation
    try:
        client = GeminiClient()
        print("GeminiClient initialized successfully.")
    except Exception as e:
        print(f"Initialization failed: {e}")
